
{% extends 'base.html' %}
{% block title %}{{ 'الحضور' if lang == 'ar' else 'Attendance' }}{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2 class="theme-color fw-bold text-center"><i class="bi bi-calendar-check"></i> {{ 'الحضور والانصراف' if lang == 'ar' else 'Attendance & Check-in' }}</h2>
    </div>
    <!-- Cards Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-4 col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <span class="fs-1 text-success"><i class="bi bi-person-check"></i></span>
                    <h6 class="mt-2">{{ 'عدد الحضور اليوم' if lang == 'ar' else 'Today Check-ins' }}</h6>
                    <div class="display-6 fw-bold">{{ today_checkins or 0 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <span class="fs-1 text-primary"><i class="bi bi-person-x"></i></span>
                    <h6 class="mt-2">{{ 'عدد الانصراف اليوم' if lang == 'ar' else 'Today Check-outs' }}</h6>
                    <div class="display-6 fw-bold">{{ today_checkouts or 0 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <span class="fs-1 text-warning"><i class="bi bi-clock-history"></i></span>
                    <h6 class="mt-2">{{ 'إجمالي السجلات' if lang == 'ar' else 'Total Records' }}</h6>
                    <div class="display-6 fw-bold">{{ attendance_log|length }}</div>
                </div>
            </div>
        </div>
    </div>
    <!-- تسجيل الحضور والانصراف -->
    <div class="card mb-4">
        <div class="card-header bg-theme text-white fw-bold"><i class="bi bi-calendar-plus"></i> {{ 'تسجيل الحضور/الانصراف' if lang == 'ar' else 'Check-in/Check-out' }}</div>
        <div class="card-body text-center">
            <button class="btn bg-theme me-2" id="checkin-btn"><i class="bi bi-box-arrow-in-right"></i> {{ 'تسجيل دخول' if lang == 'ar' else 'Check-in' }}</button>
            <button class="btn btn-outline-primary" id="checkout-btn"><i class="bi bi-box-arrow-right"></i> {{ 'تسجيل خروج' if lang == 'ar' else 'Check-out' }}</button>
            <div id="gps-status" class="mt-3"></div>
        </div>
    </div>
    <!-- سجل الحضور -->
    <div class="card">
        <div class="card-header bg-theme text-white fw-bold"><i class="bi bi-table"></i> {{ 'سجل الحضور' if lang == 'ar' else 'Attendance Log' }}</div>
        <div class="card-body p-0">
            <div class="table-responsive">
            <table class="table table-bordered table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>{{ 'العملية' if lang == 'ar' else 'Action' }}</th>
                        <th>{{ 'الوقت' if lang == 'ar' else 'Time' }}</th>
                        <th>{{ 'الموقع' if lang == 'ar' else 'Location' }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for att in attendance_log %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ att.action }}</td>
                        <td>{{ att.time }}</td>
                        <td>{{ att.address }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>
<script>
function getLocation(action) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            // Google Reverse Geocoding
            fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${position.coords.latitude},${position.coords.longitude}&key=AIzaSyC7OYfdpB1HU5Ui6YYDfCfOyXG4jDsea00`)
            .then(res => res.json())
            .then(geo => {
                let address = geo.results[0]?.formatted_address || '';
                fetch('/api/attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        address: address
                    })
                }).then(res => res.json()).then(data => {
                    document.getElementById('gps-status').innerText = data.status;
                    window.location.reload();
                });
            });
        });
    } else {
        document.getElementById('gps-status').innerText = "المتصفح لا يدعم تحديد الموقع";
    }
}
document.getElementById('checkin-btn').onclick = function() { getLocation('حضور'); };
document.getElementById('checkout-btn').onclick = function() { getLocation('انصراف'); };
</script>
{% endblock %}
