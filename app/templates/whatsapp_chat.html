{% extends "base.html" %}

{% block title %}Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§ØªØ³Ø§Ø¨ - {{ customer_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ {{ customer_name }}</h4>
                <small>{{ customer_phone }}</small>
            </div>
            <div class="card-body">
                <div class="whatsapp-chat-interface">
                    <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
                    <div class="chat-header">
                        <div class="customer-info">
                            <span class="customer-name">{{ customer_name }}</span>
                            <span class="customer-phone">{{ customer_phone }}</span>
                        </div>
                        <div class="chat-actions">
                            <button class="btn btn-outline-light btn-sm" onclick="makeAudioCall()">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø©</button>
                            <button class="btn btn-outline-light btn-sm" onclick="attachFile()">ğŸ“ Ø¥Ø±ÙØ§Ù‚</button>
                        </div>
                    </div>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
                    <div class="messages-container" id="messages-container">
                        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </div>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
                    <div class="message-input-area">
                        <div class="input-options">
                            <button class="btn btn-outline-secondary btn-sm" onclick="recordAudio()">ğŸ¤</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="takePhoto()">ğŸ“·</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="attachFile()">ğŸ“</button>
                        </div>

                        <textarea
                            id="message-input"
                            class="form-control"
                            placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                            rows="2"
                        ></textarea>

                        <button class="btn btn-success send-button" onclick="sendMessage()">
                            â†— Ø¥Ø±Ø³Ø§Ù„
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
<div id="preview-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="confirmSend()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCustomerPhone = '{{ customer_phone }}';

// ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
function loadCustomerChat() {
    fetch(`/api/whatsapp/conversation/${currentCustomerPhone}`)
        .then(response => response.json())
        .then(messages => {
            displayMessages(messages);
        })
        .catch(error => console.error('Error loading chat:', error));
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function displayMessages(messages) {
    const container = document.getElementById('messages-container');
    container.innerHTML = '';

    messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.direction}`;

        let content = '';
        switch(msg.message_type) {
            case 'text':
                content = `<div class="text-message">${msg.message_content}</div>`;
                break;
            case 'image':
                content = `
                    <div class="image-message">
                        <img src="${msg.message_content}" alt="ØµÙˆØ±Ø©" class="img-fluid rounded">
                    </div>`;
                break;
            case 'audio':
                content = `
                    <div class="audio-message">
                        <audio controls class="w-100">
                            <source src="${msg.message_content}" type="audio/mpeg">
                        </audio>
                    </div>`;
                break;
            case 'document':
                content = `
                    <div class="document-message">
                        <a href="${msg.message_content}" target="_blank" class="btn btn-outline-primary btn-sm">
                            ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
                        </a>
                    </div>`;
                break;
        }

        messageDiv.innerHTML = content;
        container.appendChild(messageDiv);
    });

    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
    container.scrollTop = container.scrollHeight;
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();

    if(message) {
        const payload = {
            phone: currentCustomerPhone,
            message: message,
            type: 'text'
        };

        fetch('/api/whatsapp/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if(result.success) {
                input.value = '';
                loadCustomerChat();
            } else {
                alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
        });
    }
}

// ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©
function recordAudio() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª');
        return;
    }

    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            const recorder = new MediaRecorder(stream);
            const chunks = [];

            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/mpeg' });
                uploadAudio(blob);
                stream.getTracks().forEach(track => track.stop());
            };

            recorder.start();
            alert('Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... Ø§Ø¶ØºØ· OK Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„');

            setTimeout(() => {
                if(recorder.state === 'recording') {
                    recorder.stop();
                }
            }, 30000); // Ø¥ÙŠÙ‚Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
        })
        .catch(error => {
            console.error('Error recording audio:', error);
            alert('ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª');
        });
}

// Ø±ÙØ¹ Ù…Ù„Ù Ù…Ø±ÙÙ‚
function attachFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,audio/*,.pdf,.doc,.docx';

    input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
            uploadFile(file);
        }
    };

    input.click();
}

// Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°)
function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© endpoint Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù ÙƒØ±Ø³Ø§Ù„Ø©
            const payload = {
                phone: currentCustomerPhone,
                message: result.url,
                type: file.type.startsWith('image/') ? 'image' :
                      file.type.startsWith('audio/') ? 'audio' : 'document'
            };

            fetch('/api/whatsapp/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(() => loadCustomerChat());
        }
    });
}

// Ø±ÙØ¹ Ø§Ù„ØµÙˆØª (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚)
function uploadAudio(blob) {
    const formData = new FormData();
    formData.append('file', blob, 'audio.mp3');

    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const payload = {
                phone: currentCustomerPhone,
                message: result.url,
                type: 'audio'
            };

            fetch('/api/whatsapp/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(() => loadCustomerChat());
        }
    });
}

// Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ© (ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°)
function makeAudioCall() {
    alert('Ù…ÙŠØ²Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
}

// Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© (ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°)
function takePhoto() {
    alert('Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    loadCustomerChat();

    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†
    setInterval(loadCustomerChat, 10000);
});

// Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>

<style>
.whatsapp-chat-interface {
    border: 1px solid #ddd;
    border-radius: 10px;
    height: 600px;
    display: flex;
    flex-direction: column;
    background: #e5ddd5;
}

.chat-header {
    background: #25D366;
    color: white;
    padding: 15px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.customer-info {
    display: flex;
    flex-direction: column;
}

.customer-name {
    font-weight: bold;
}

.customer-phone {
    font-size: 0.9em;
    opacity: 0.8;
}

.chat-actions {
    display: flex;
    gap: 10px;
}

.messages-container {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #e5ddd5;
}

.message {
    margin-bottom: 10px;
    max-width: 70%;
    clear: both;
}

.message.incoming {
    float: right;
    background: white;
    border-radius: 10px 10px 0 10px;
    padding: 10px;
    margin-left: auto;
}

.message.outgoing {
    float: left;
    background: #dcf8c6;
    border-radius: 10px 10px 10px 0;
    padding: 10px;
    margin-right: auto;
}

.message-input-area {
    padding: 15px;
    border-top: 1px solid #ddd;
    background: white;
    display: flex;
    align-items: center;
    gap: 10px;
}

.input-options {
    display: flex;
    gap: 5px;
}

#message-input {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    resize: none;
    padding: 10px;
}

.send-button {
    background: #25D366;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
}

.audio-message audio {
    width: 250px;
    height: 40px;
}

.image-message img {
    max-width: 300px;
    border-radius: 10px;
}
</style>
{% endblock %}