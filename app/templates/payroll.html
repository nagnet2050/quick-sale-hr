{% extends 'base.html' %}
{% block title %}{{ 'الرواتب' if lang == 'ar' else 'Payroll' }}{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2 class="theme-color fw-bold text-center"><i class="bi bi-cash-stack"></i> {{ 'إدارة الرواتب' if lang == 'ar' else 'Payroll Management' }}</h2>
    </div>
    <!-- Cards Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-4 col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <span class="fs-1 text-success"><i class="bi bi-cash-stack"></i></span>
                    <h6 class="mt-2">{{ 'إجمالي الرواتب' if lang == 'ar' else 'Total Payroll' }}</h6>
                    <div class="display-6 fw-bold">{{ total_payroll or 0 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <span class="fs-1 text-primary"><i class="bi bi-person-check"></i></span>
                    <h6 class="mt-2">{{ 'عدد الرواتب المدفوعة' if lang == 'ar' else 'Paid Payrolls' }}</h6>
                    <div class="display-6 fw-bold">{{ paid_payrolls or 0 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <span class="fs-1 text-danger"><i class="bi bi-person-x"></i></span>
                    <h6 class="mt-2">{{ 'الرواتب غير المدفوعة' if lang == 'ar' else 'Unpaid Payrolls' }}</h6>
                    <div class="display-6 fw-bold">{{ unpaid_payrolls or 0 }}</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Filter (GET) -->
    <div class="card mb-4">
        <div class="card-header bg-theme text-white fw-bold"><i class="bi bi-funnel"></i> {{ 'تصفية الرواتب' if lang == 'ar' else 'Payroll Filter' }}</div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">{{ 'بداية الفترة' if lang == 'ar' else 'Period Start' }}</label>
                    <input type="date" name="period_start" value="{{ filters.period_start or '' }}" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ 'نهاية الفترة' if lang == 'ar' else 'Period End' }}</label>
                    <input type="date" name="period_end" value="{{ filters.period_end or '' }}" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ 'الموظف' if lang == 'ar' else 'Employee' }}</label>
                    <select name="employee_id" class="form-control">
                        <option value="">{{ 'الكل' if lang=='ar' else 'All' }}</option>
                        {% for e in employees %}
                        <option value="{{ e.id }}" {% if filters.employee_id and filters.employee_id|int == e.id %}selected{% endif %}>{{ e.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn bg-theme" type="submit"><i class="bi bi-funnel"></i> {{ 'تصفية' if lang=='ar' else 'Filter' }}</button>
                    <a class="btn btn-outline-secondary ms-2" href="{{ url_for('payroll.payroll_export') }}?period_start={{ filters.period_start or '' }}&period_end={{ filters.period_end or '' }}&employee_id={{ filters.employee_id or '' }}"><i class="bi bi-file-earmark-arrow-down"></i> {{ 'تصدير CSV' if lang=='ar' else 'Export CSV' }}</a>
                </div>
            </form>
        </div>
    </div>
    <!-- Generate form (POST) -->
    <div class="card mb-4">
        <div class="card-header bg-theme text-white fw-bold"><i class="bi bi-plus-circle"></i> {{ 'توليد رواتب جديدة' if lang == 'ar' else 'Generate New Payroll' }}</div>
        <div class="card-body">
            <form method="POST" class="row g-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="col-md-2">
                    <label class="form-label">{{ 'بداية الفترة' if lang == 'ar' else 'Period Start' }}</label>
                    <input type="date" name="period_start" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ 'نهاية الفترة' if lang == 'ar' else 'Period End' }}</label>
                    <input type="date" name="period_end" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ 'الموظف (اختياري)' if lang=='ar' else 'Employee (optional)' }}</label>
                    <select name="employee_id" class="form-control">
                        <option value="">{{ 'الكل' if lang=='ar' else 'All' }}</option>
                        {% for e in employees %}
                        <option value="{{ e.id }}">{{ e.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ 'مكافأة (اختياري)' if lang=='ar' else 'Bonus (optional)' }}</label>
                    <input type="number" step="0.01" name="bonus" class="form-control" placeholder="0.00">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ 'عمل إضافي (مبلغ)' if lang=='ar' else 'Overtime (amount)' }}</label>
                    <input type="number" step="0.01" name="overtime" class="form-control" placeholder="0.00">
                </div>
                <div class="col-md-2 align-self-end">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <input type="number" step="0.01" name="deductions" class="form-control d-inline-block w-50" placeholder="{{ 'الخصومات' if lang=='ar' else 'Deductions' }}">
                        <button class="btn bg-theme ms-2" type="submit"><i class="bi bi-plus-circle"></i> {{ 'توليد رواتب' if lang == 'ar' else 'Generate Payroll' }}</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- جدول الرواتب -->
    <div class="card">
        <div class="card-header bg-theme text-white fw-bold d-flex align-items-center justify-content-between">
            <div><i class="bi bi-table"></i> {{ 'قائمة الرواتب' if lang == 'ar' else 'Payroll List' }}</div>
            <div class="d-flex align-items-center gap-2">
                <input type="number" min="1" max="12" id="batchMonth" class="form-control form-control-sm w-auto" placeholder="{{ 'شهر' if lang=='ar' else 'Month' }}">
                <input type="number" min="2000" max="2100" id="batchYear" class="form-control form-control-sm w-auto" placeholder="{{ 'سنة' if lang=='ar' else 'Year' }}">
                <button type="button" class="btn btn-sm btn-outline-light" onclick="batchRecalc()">
                    <i class="bi bi-arrow-repeat"></i> {{ 'إعادة حساب جماعي' if lang=='ar' else 'Batch Recalculate' }}
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
            <table class="table table-bordered table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>{{ 'الموظف' if lang == 'ar' else 'Employee' }}</th>
                        <th>{{ 'الفترة' if lang == 'ar' else 'Period' }}</th>
                        <th>{{ 'الأساسي' if lang == 'ar' else 'Basic' }}</th>
                        <th>{{ 'البدلات' if lang == 'ar' else 'Allowances' }}</th>
                        <th>{{ 'المكافأة' if lang=='ar' else 'Bonus' }}</th>
                        <th>{{ 'العمل الإضافي' if lang=='ar' else 'Overtime' }}</th>
                        <th>{{ 'الخصومات' if lang == 'ar' else 'Deductions' }}</th>
                        <th>{{ 'الضريبة' if lang=='ar' else 'Tax' }}</th>
                        <th>{{ 'التأمين' if lang=='ar' else 'Insurance' }}</th>
                        <th>{{ 'الصافي' if lang == 'ar' else 'Net' }}</th>
                        <th>{{ 'تاريخ الإنشاء' if lang == 'ar' else 'Generated At' }}</th>
                        <th>{{ 'الحالة' if lang == 'ar' else 'Status' }}</th>
                        <th>{{ 'الإجراءات' if lang == 'ar' else 'Actions' }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in payroll_rows %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ p.employee }}</td>
                        <td>{{ p.period_start }} - {{ p.period_end }}</td>
                        <td>{{ p.basic }}</td>
                        <td>{{ p.allowances }}</td>
                        <td>{{ p.bonus if p.bonus is defined else '' }}</td>
                        <td>{{ p.overtime if p.overtime is defined else '' }}</td>
                        <td>{{ p.deductions }}</td>
                        <td>{{ p.tax if p.tax is defined else '' }}</td>
                        <td>{{ p.insurance if p.insurance is defined else '' }}</td>
                        <td>
                            {{ p.net }}
                            {% if p.last_recalc_net_diff is defined and p.last_recalc_net_diff %}
                                {% set diff = p.last_recalc_net_diff %}
                                <span class="badge rounded-pill ms-1 {{ 'bg-success' if diff>0 else 'bg-danger' }}" title="{{ 'آخر إعادة:' if lang=='ar' else 'Last recalc:' }} {{ p.last_recalc_at if p.last_recalc_at is defined else '' }}">
                                    {{ '+' if diff>0 else '' }}{{ '%.2f'|format(diff) }}
                                </span>
                            {% endif %}
                        </td>
                        <td>{{ p.generated_at }}</td>
                        <td>
                            {% if p.status == 'paid' %}
                                <span class="badge bg-success">{{ 'مدفوع' if lang == 'ar' else 'Paid' }}</span>
                            {% else %}
                                <span class="badge bg-warning">{{ 'غير مدفوع' if lang == 'ar' else 'Unpaid' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('payroll.payslip', payroll_id=p.id) }}"><i class="bi bi-file-earmark-pdf"></i> {{ 'قسيمة' if lang=='ar' else 'Payslip' }}</a>
                            {% if p.status != 'paid' %}
                            <button type="button" class="btn btn-sm btn-outline-warning ms-1" onclick="recalcFromAttendance({{ p.id }})">
                                <i class="bi bi-arrow-clockwise"></i> {{ 'إعادة الحساب' if lang=='ar' else 'Recalculate' }}
                            </button>
                            <form method="POST" action="/payroll/pay/{{ p.id }}" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <select name="payment_method" class="form-select form-select-sm d-inline w-auto">
                                    <option value="cash">{{ 'نقداً' if lang == 'ar' else 'Cash' }}</option>
                                    <option value="transfer">{{ 'تحويل' if lang == 'ar' else 'Transfer' }}</option>
                                </select>
                                <button class="btn btn-sm btn-success ms-2" type="submit">{{ 'دفع' if lang == 'ar' else 'Pay' }}</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="14">{{ 'لا توجد سجلات' if lang=='ar' else 'No records' }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>
<script>
async function recalcFromAttendance(id) {
    try {
        const res = await fetch(`/api/payroll/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recalc_from_attendance: true })
        });
        const data = await res.json();
        if (res.ok && data.success) {
            // استخدم Swal إن وجد، وإلا فتنبيه بسيط
            if (window.Swal) {
                await Swal.fire({ icon: 'success', title: '{{ "تم" if lang=="ar" else "Done" }}', text: '{{ "تمت إعادة الحساب من الحضور" if lang=="ar" else "Recalculated from attendance" }}' });
            } else {
                alert('{{ "تمت إعادة الحساب من الحضور" if lang=="ar" else "Recalculated from attendance" }}');
            }
            location.reload();
        } else {
            const msg = (data && data.error) ? data.error : 'Error';
            if (window.Swal) {
                Swal.fire({ icon: 'error', title: '{{ "خطأ" if lang=="ar" else "Error" }}', text: msg });
            } else {
                alert(msg);
            }
        }
    } catch (e) {
        if (window.Swal) {
            Swal.fire({ icon: 'error', title: '{{ "خطأ" if lang=="ar" else "Error" }}', text: String(e) });
        } else {
            alert(String(e));
        }
    }
}

async function batchRecalc() {
    const month = parseInt(document.getElementById('batchMonth').value, 10);
    const year = parseInt(document.getElementById('batchYear').value, 10);
    if (!month || !year) {
        if (window.Swal) {
            return Swal.fire({ icon: 'warning', title: '{{ "تنبيه" if lang=="ar" else "Notice" }}', text: '{{ "الرجاء إدخال الشهر والسنة" if lang=="ar" else "Please enter month and year" }}' });
        } else {
            return alert('{{ "الرجاء إدخال الشهر والسنة" if lang=="ar" else "Please enter month and year" }}');
        }
    }
    try {
        const res = await fetch('/api/payroll/recalc/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ month, year })
        });
        const data = await res.json();
        if (res.ok && data.success) {
            const msg = `{{ 'تم تحديث' if lang=='ar' else 'Updated' }} ${data.updated} {{ 'سجل' if lang=='ar' else 'records' }} (Δ {{ '%.2f'|format(0) }})`;
            if (window.Swal) {
                await Swal.fire({ icon: 'success', title: '{{ "تم" if lang=="ar" else "Done" }}', text: `${msg.replace('(Δ 0.00)', '')} (Δ ${data.total_diff})` });
            } else {
                alert(`${msg} (Δ ${data.total_diff})`);
            }
            location.reload();
        } else {
            const msg = (data && data.error) ? data.error : 'Error';
            if (window.Swal) {
                Swal.fire({ icon: 'error', title: '{{ "خطأ" if lang=="ar" else "Error" }}', text: msg });
            } else {
                alert(msg);
            }
        }
    } catch (e) {
        if (window.Swal) {
            Swal.fire({ icon: 'error', title: '{{ "خطأ" if lang=="ar" else "Error" }}', text: String(e) });
        } else {
            alert(String(e));
        }
    }
}
</script>
{% endblock %}
