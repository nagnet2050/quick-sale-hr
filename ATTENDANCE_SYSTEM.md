# 🎯 نظام الحضور والانصراف المتطور

## 📋 نظرة عامة

تم تطوير نظام الحضور والانصراف ليشمل **ثلاثة مستويات من التحقق** لضمان دقة وأمان تسجيل الحضور:

### ✅ مستويات التحقق

1. **📍 التحقق من الموقع (GPS Location)**
   - يتحقق من وجود الموظف داخل نطاق معين من مقر الشركة
   - يحسب المسافة بين موقع الموظف وموقع الشركة
   - يمكن ضبط المسافة المسموحة (افتراضياً: 100 متر)

2. **⏰ التحقق من الوقت (Time Verification)**
   - يتحقق من أن الحضور/الانصراف خلال الأوقات المحددة
   - أوقات الحضور الافتراضية: 7:00 ص - 10:00 ص
   - أوقات الانصراف الافتراضية: 2:00 م - 6:00 م
   - إمكانية السماح بالتسجيل خارج الأوقات مع تحذير

3. **💻 التحقق من الجهاز (Device Fingerprinting)**
   - يحدد الجهاز المستخدم باستخدام Device Fingerprinting
   - يمكن تسجيل أجهزة معينة لكل موظف
   - منع التسجيل من أجهزة غير مسجلة

---

## 🔧 الإعدادات

### الوصول إلى صفحة الإعدادات

**المسار:** `/attendance/settings`  
**الصلاحيات المطلوبة:** Admin فقط

### إعدادات الموقع

```
- خط العرض (Latitude): موقع الشركة (مثال: 30.0444)
- خط الطول (Longitude): موقع الشركة (مثال: 31.2357)
- المسافة المسموحة: بالمتر (افتراضياً: 100 متر)
- تفعيل/تعطيل التحقق من الموقع
```

**زر "استخدام موقعي الحالي":** يحدد موقعك الحالي تلقائياً كموقع الشركة

### إعدادات الوقت

```
أوقات الحضور:
- من: 07:00 (قابل للتعديل)
- إلى: 10:00 (قابل للتعديل)

أوقات الانصراف:
- من: 14:00 (قابل للتعديل)
- إلى: 18:00 (قابل للتعديل)

خيارات:
✓ تفعيل التحقق من الوقت
✓ السماح بالتسجيل خارج الأوقات (مع تحذير)
```

### إعدادات الأجهزة

```
✓ تفعيل/تعطيل التحقق من الجهاز
- عند التفعيل: فقط الأجهزة المسجلة يمكنها التسجيل
```

---

## 📱 كيفية استخدام النظام

### للموظف

1. **تسجيل الحضور:**
   - افتح صفحة الحضور
   - اضغط على زر "حضور"
   - السماح للمتصفح بالوصول إلى الموقع
   - سيظهر رسالة بحالة التسجيل مع تفاصيل التحقق

2. **تسجيل الانصراف:**
   - اضغط على زر "انصراف"
   - سيتم التحقق من الموقع والوقت والجهاز
   - سيظهر رسالة التأكيد

### للمدير

1. **تسجيل حضور/انصراف الموظفين:**
   - اختر الموظف من القائمة المنسدلة
   - اضغط على الزر المناسب

2. **ضبط الإعدادات:**
   - من صفحة الحضور، اضغط على "إعدادات الحضور"
   - عدّل الإعدادات حسب الحاجة
   - اضغط "حفظ الإعدادات"

---

## 🔐 إدارة الأجهزة المسجلة

### تسجيل جهاز جديد

**API Endpoint:** `POST /api/attendance/register-device`

```json
{
  "employee_id": 123,
  "mac_address": "00:11:22:33:44:55",
  "device_name": "Laptop - Ahmed",
  "device_info": "Windows 11 - Chrome 120"
}
```

### الحصول على أجهزة موظف

**API Endpoint:** `GET /api/attendance/devices/{employee_id}`

### حذف جهاز

**API Endpoint:** `DELETE /api/attendance/device/{device_id}`

### تفعيل/تعطيل جهاز

**API Endpoint:** `POST /api/attendance/device/{device_id}/toggle`

---

## 📊 تفاصيل التحقق

عند تسجيل الحضور/الانصراف، يحصل الموظف على تفاصيل كاملة عن حالة التحقق:

```
تفاصيل التحقق:
📍 الموقع: ✓ الموقع صحيح (المسافة: 45 متر)
⏰ الوقت: ✓ الوقت مناسب للحضور
💻 الجهاز: ✓ الجهاز مسجل: Laptop - Ahmed
```

---

## 🗄️ قاعدة البيانات

### جدول attendance (محدّث)

```sql
- mac_address (VARCHAR): معرف الجهاز
- device_info (VARCHAR): معلومات الجهاز
- location_verified (BOOLEAN): هل الموقع صحيح؟
- time_verified (BOOLEAN): هل الوقت صحيح؟
- device_verified (BOOLEAN): هل الجهاز مسجل؟
- verification_notes (TEXT): ملاحظات التحقق
```

### جدول attendance_settings (جديد)

```sql
- company_lat/lng: موقع الشركة
- max_distance_meters: المسافة المسموحة
- check_in_start/end: أوقات الحضور
- check_out_start/end: أوقات الانصراف
- require_*_verification: خيارات التفعيل
- allow_outside_hours: السماح خارج الأوقات
```

### جدول registered_device (جديد)

```sql
- employee_id: الموظف
- mac_address: معرف الجهاز (فريد)
- device_name: اسم الجهاز
- device_info: معلومات الجهاز
- is_active: مفعّل؟
- registered_at: تاريخ التسجيل
- last_used: آخر استخدام
```

---

## 🛠️ API Reference

### 1. تسجيل الحضور/الانصراف

**Endpoint:** `POST /api/attendance`

**Request Body:**
```json
{
  "action": "حضور",
  "employee_id": 123,
  "lat": 30.0444,
  "lng": 31.2357,
  "address": "Cairo, Egypt",
  "mac_address": "a1:b2:c3:d4:e5:f6",
  "device_info": "Windows 11 - Chrome"
}
```

**Success Response:**
```json
{
  "status": "success",
  "message": "تم تسجيل الحضور بنجاح",
  "verification_details": {
    "location": {
      "verified": true,
      "message": "الموقع صحيح (المسافة: 45 متر)"
    },
    "time": {
      "verified": true,
      "message": "الوقت مناسب للحضور"
    },
    "device": {
      "verified": true,
      "message": "الجهاز مسجل: Laptop"
    }
  }
}
```

**Error Response:**
```json
{
  "status": "error",
  "message": "فشل التحقق من الموقع: الموقع بعيد عن الشركة (المسافة: 500 متر، المسموح: 100 متر)",
  "verification_details": { ... }
}
```

### 2. الحصول على الإعدادات

**Endpoint:** `GET /api/attendance/settings`

### 3. تحديث الإعدادات

**Endpoint:** `POST /api/attendance/settings`

---

## 🎨 Device Fingerprinting

نظراً لأن JavaScript لا يمكنها الوصول المباشر لـ MAC Address، نستخدم **Device Fingerprinting** الذي يجمع:

```javascript
- User Agent
- Platform (OS)
- Screen Resolution
- Language
- Timezone
- Canvas Fingerprint
```

يتم دمج هذه المعلومات وتشفيرها بـ SHA-256 لإنشاء معرف فريد للجهاز.

---

## 🔄 سيناريوهات الاستخدام

### سيناريو 1: موظف يسجل حضور طبيعي
```
✓ الموقع: داخل النطاق (50 متر)
✓ الوقت: 8:30 ص (ضمن 7:00-10:00)
✓ الجهاز: مسجل
→ النتيجة: تم التسجيل بنجاح
```

### سيناريو 2: موظف متأخر
```
✓ الموقع: داخل النطاق
✗ الوقت: 10:30 ص (خارج 7:00-10:00)
✓ الجهاز: مسجل
→ النتيجة: رفض (إلا إذا كان allow_outside_hours مفعل)
```

### سيناريو 3: موظف من جهاز جديد
```
✓ الموقع: داخل النطاق
✓ الوقت: صحيح
✗ الجهاز: غير مسجل
→ النتيجة: رفض (إذا كان require_device_verification مفعل)
```

---

## 📈 الميزات المتقدمة

1. **حساب المسافة الدقيق:** باستخدام Haversine Formula
2. **رسائل توضيحية:** كل عملية تحقق تعطي رسالة مفصلة
3. **مرونة الإعدادات:** يمكن تفعيل/تعطيل أي نوع من التحقق
4. **السماح بالاستثناءات:** السماح بالتسجيل خارج الأوقات مع تسجيل ملاحظة
5. **سجل كامل:** كل تسجيل يحفظ نتائج التحقق الثلاثة

---

## 🚀 التثبيت والتحديث

### تحديث قاعدة البيانات

```bash
python upgrade_attendance.py
```

هذا السكريبت سيضيف:
- ✓ 6 أعمدة جديدة لجدول attendance
- ✓ جدول attendance_settings
- ✓ جدول registered_device
- ✓ Indexes للأداء الأمثل

---

## 📝 ملاحظات مهمة

1. **الخصوصية:** Device Fingerprinting لا يكشف معلومات شخصية، فقط معرف فريد للجهاز
2. **الأمان:** كل الإعدادات محمية بصلاحيات Admin
3. **المرونة:** يمكن تعطيل أي نوع من التحقق حسب احتياجات الشركة
4. **التوافق:** يعمل على كل المتصفحات الحديثة التي تدعم Geolocation API

---

## 🆘 استكشاف الأخطاء

### المشكلة: لا يمكن الحصول على الموقع
**الحل:** تأكد من منح المتصفح إذن الوصول للموقع

### المشكلة: الموقع بعيد جداً
**الحل:** زيادة max_distance_meters في الإعدادات

### المشكلة: لا يمكن التسجيل خارج الأوقات
**الحل:** تفعيل allow_outside_hours في الإعدادات

### المشكلة: رفض الجهاز
**الحل:** 
1. تسجيل الجهاز عبر API
2. أو تعطيل require_device_verification

---

تم تطوير النظام بواسطة GitHub Copilot 🤖
